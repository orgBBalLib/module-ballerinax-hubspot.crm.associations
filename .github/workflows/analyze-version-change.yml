name: Analyze Version Change

on:
  workflow_dispatch:
  repository_dispatch:
    types: [analyze-connector-changes]

jobs:
  analyze:
    name: Analyze connector version changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: latest

      - name: Find auto-generate-connector branch
        id: find_branch
        run: |
          git fetch origin
          BRANCH_NAME=$(git branch -r | grep -E 'origin/auto-generate-connector' | \
            sed 's/origin\///' | \
            sed 's/^[[:space:]]*//' | \
            sort -r | \
            head -1)

          if [ -z "$BRANCH_NAME" ]; then
            echo "Error: No auto-generate-connector branch found"
            exit 1
          fi

          echo "Found latest branch: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Generate git diff for client.bal and types.bal
        id: diff
        run: |
          BRANCH_NAME="${{ steps.find_branch.outputs.branch_name }}"
          echo "Generating diff between origin/main and origin/$BRANCH_NAME..."

          git diff origin/main..origin/$BRANCH_NAME -- ballerina/client.bal > client_diff.txt || true
          git diff origin/main..origin/$BRANCH_NAME -- ballerina/types.bal > types_diff.txt || true
          cat client_diff.txt types_diff.txt > git_diff.txt

          if [ ! -s git_diff.txt ]; then
            echo "No changes detected in client.bal or types.bal"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Diff generated successfully"
          echo "Client diff size: $(wc -c < client_diff.txt) bytes"
          echo "Types diff size: $(wc -c < types_diff.txt) bytes"
          echo "Combined diff size: $(wc -c < git_diff.txt) bytes"

      - name: Run analysis
        if: steps.diff.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          DIFF_CONTENT=$(cat git_diff.txt)
          cd scripts
          bal run analyze_version_change.bal -- "$DIFF_CONTENT"
          mv analysis_result.json ../

      - name: Display results
        if: always()
        run: |
          if [ -f analysis_result.json ]; then
            echo "Analysis Results:"
            cat analysis_result.json | jq '.'
          else
            echo "No analysis result file found"
          fi

      - name: Update version in gradle.properties
        if: steps.diff.outputs.has_changes == 'true'
        id: update_version
        run: |
          BRANCH_NAME="${{ steps.find_branch.outputs.branch_name }}"
          git stash || true
          git checkout $BRANCH_NAME

          CHANGE_TYPE=$(jq -r '.changeType' analysis_result.json)
          CURRENT_VERSION=$(grep '^version=' gradle.properties | cut -d'=' -f2)
          echo "Current version: $CURRENT_VERSION"

          BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-SNAPSHOT//')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

          case $CHANGE_TYPE in
            MAJOR)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            MINOR)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            PATCH)
              PATCH=$((PATCH + 1))
              ;;
            *)
              echo "Unknown change type: $CHANGE_TYPE"
              exit 1
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-SNAPSHOT"
          echo "New version: $NEW_VERSION"

          sed -i "s/^version=.*/version=$NEW_VERSION/" gradle.properties

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "change_type=$CHANGE_TYPE" >> $GITHUB_OUTPUT

      - name: Set up Java
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Gradle build to generate Ballerina files
        id: gradle_build
        if: steps.diff.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          packageUser: ${{ github.actor }}
          packagePAT: ${{ secrets.PAT_TOKEN }}
        run: |
          ./gradlew build -x test
          echo "Generated Ballerina files:"
          ls -la ballerina/Ballerina.toml ballerina/Dependencies.toml || true

      - name: Commit version changes and generated files
        if: steps.diff.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="${{ steps.find_branch.outputs.branch_name }}"
          git config --local user.email "ballerina-bot@ballerina.io"
          git config --local user.name "ballerina-bot"

          git add gradle.properties

          if [ -f ballerina/Ballerina.toml ]; then
            git add ballerina/Ballerina.toml
          fi
          if [ -f ballerina/Dependencies.toml ]; then
            git add ballerina/Dependencies.toml
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MSG="Update version to ${{ steps.update_version.outputs.new_version }}"
            if [ "${{ steps.gradle_build.outcome }}" == "failure" ]; then
              COMMIT_MSG="$COMMIT_MSG [Gradle build failed - manual intervention required]"
            else
              COMMIT_MSG="$COMMIT_MSG and regenerate Ballerina files"
            fi
            git commit -m "$COMMIT_MSG"
          fi

          git push origin $BRANCH_NAME

      - name: Create Pull Request
        if: steps.diff.outputs.has_changes == 'true'
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const fs = require('fs');
            const analysis = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));
            const gradleBuildFailed = '${{ steps.gradle_build.outcome }}' === 'failure';
            const branchName = '${{ steps.find_branch.outputs.branch_name }}';

            // Helper function to format change items with better code highlighting
            function formatChange(change) {
              // Pattern to match common change descriptions
              // Example: "Method signature changed for 'post associations/[string fromObjectType]/[string toObjectType]/batch/archive' - return type changed from 'error?' to 'BatchResponseVoid|error'"

              // Try to split on common patterns like " - " or ": "
              const separators = [' - ', ': ', ' â€“ '];
              let separator = null;
              let splitIndex = -1;

              for (const sep of separators) {
                const idx = change.indexOf(sep);
                if (idx > -1) {
                  separator = sep;
                  splitIndex = idx;
                  break;
                }
              }

              if (splitIndex > -1) {
                // Split into description and details
                const description = change.substring(0, splitIndex);
                const details = change.substring(splitIndex + separator.length);

                // Check if description contains code (quotes or specific patterns)
                const descHasCode = description.includes("'") || description.includes('"') || description.includes('`');

                if (descHasCode) {
                  // Extract code parts from description
                  const descFormatted = description.replace(/'([^']+)'/g, '`$1`').replace(/"([^"]+)"/g, '`$1`');
                  return `${descFormatted} - ${details}`;
                } else {
                  // Description is plain text, details might be code
                  return `${description} - \`${details}\``;
                }
              }

              // Fallback: if it contains quotes, format those as code
              if (change.includes("'") || change.includes('"')) {
                return change.replace(/'([^']+)'/g, '`$1`').replace(/"([^"]+)"/g, '`$1`');
              }

              // Otherwise return as-is
              return change;
            }

            let prBody = `## Version Change Analysis\n\n`;

            if (gradleBuildFailed) {
              prBody += `> WARNING: GRADLE BUILD FAILED - The Gradle build step failed during this workflow run. Manual intervention is required to fix the build issues before merging this PR.\n\n`;
            }

            prBody += `**Recommended Version Bump:** \`${analysis.changeType}\`\n`;
            prBody += `**New Version:** \`${{ steps.update_version.outputs.new_version }}\`\n`;
            prBody += `**Confidence:** ${analysis.confidence}\n`;
            prBody += `**Build Status:** ${gradleBuildFailed ? 'FAILED' : 'Success'}\n\n`;
            prBody += `### Summary\n${analysis.summary}\n\n`;

            if (analysis.breakingChanges.length > 0) {
              prBody += `### Breaking Changes\n`;
              analysis.breakingChanges.forEach(change => {
                prBody += `- ${formatChange(change)}\n`;
              });
              prBody += '\n';
            }

            if (analysis.newFeatures.length > 0) {
              prBody += `### New Features\n`;
              analysis.newFeatures.forEach(feature => {
                prBody += `- ${formatChange(feature)}\n`;
              });
              prBody += '\n';
            }

            if (analysis.bugFixes.length > 0) {
              prBody += `### Improvements\n`;
              analysis.bugFixes.forEach(fix => {
                prBody += `- ${formatChange(fix)}\n`;
              });
              prBody += '\n';
            }

            prBody += `---\n\n`;
            if (gradleBuildFailed) {
              prBody += `BUILD FAILED - Please fix the Gradle build errors before merging.\n`;
            }
            prBody += `Manual Review Required - Please review the changes and approve if appropriate.\n`;

            const buildStatus = gradleBuildFailed ? '[BUILD FAILED] ' : '';
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${buildStatus}[${analysis.changeType}] Auto-generated connector update - v${{ steps.update_version.outputs.new_version }}`,
              head: branchName,
              base: 'main',
              body: prBody
            });

            console.log(`Created PR #${pr.data.number}`);
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);

            return pr.data.number;

      - name: Add labels to PR
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const gradleBuildFailed = '${{ steps.gradle_build.outcome }}' === 'failure';
            const labels = ['manual-review-required'];

            if (gradleBuildFailed) {
              labels.push('build-failed');
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_pr.outputs.result }},
              labels: labels
            });

      - name: Save connector update info for daily summary
        if: steps.diff.outputs.has_changes == 'true'
        run: |
          cat > connector_update.json <<EOF
          {
            "repository": "${{ github.repository }}",
            "branch": "${{ steps.find_branch.outputs.branch_name }}",
            "changeType": "${{ steps.update_version.outputs.change_type }}",
            "newVersion": "${{ steps.update_version.outputs.new_version }}",
            "buildStatus": "${{ steps.gradle_build.outcome }}",
            "prNumber": "${{ steps.create_pr.outputs.pr_number }}",
            "prUrl": "${{ steps.create_pr.outputs.pr_url }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "Connector update info saved"
          cat connector_update.json

      - name: Upload connector update info
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: connector-update-${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ github.run_id }}
          path: connector_update.json

      - name: Upload analysis results
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: version-analysis
          path: |
            analysis_result.json
            git_diff.txt
            client_diff.txt
            types_diff.txt
